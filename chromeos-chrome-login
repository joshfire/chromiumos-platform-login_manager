#!/bin/sh

# Copyright (c) 2009 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# Perform some initial setup for the browser if necessary and then run
# it in a loop.

CHROME_DIR="/opt/google/chrome"
CHROME="$CHROME_DIR/chrome"
BOTTLE="$CHROME_DIR/bottle.sh"
COOKIE_PIPE="/tmp/cookie_pipe"
DISABLE_CHROME_RESTART="/tmp/disable_chrome_restart"
SEND_METRICS="/etc/send_metrics"

# xdg-open is used to open downloaded files.
# It runs sensible-browser, which uses $BROWSER.
export BROWSER=/opt/google/chrome/chrome

# NOTE: Do not edit the following line.
# Unofficial and official builds use different default profile dirs.
# For official builds, debian/rules sets the next line to
# "google-chrome" when the package is being built.
PROFILE_DIR=chromium

# TODO(cmasone): Chrome tracks "Consent To Send Stats" on a per user-data-dir
# basis, which is not going to work for our needs.  That needs to be addressed.

while true; do
  "$CHROME" --enable-gview \
	    --enable-sync \
	    --main-menu-url="http://welcome-cros.appspot.com/menu" \
            --no-first-run \
            --login-manager \
            --user-data-dir=/home/$USER \
            --profile=user \
            "--cookie-pipe=$COOKIE_PIPE"

  # Exit if auto-restart has been disabled.
  if test -f "$DISABLE_CHROME_RESTART"; then
    break
  fi
done
